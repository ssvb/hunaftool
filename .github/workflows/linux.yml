name: linux
on: [push, pull_request]

jobs:
  test:
    name: tests
    strategy:
      matrix:
        os: [ubuntu-latest]

    runs-on: ${{ matrix.os }}
    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 512
          swap-size-mb: 1024
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          remove-docker-images: 'true'

      - name: Report free space
        run: |
          echo "Free space:"
          df -h

      - uses: actions/checkout@v3

      - name: Install Ruby and Crystal
        run: |
          sudo apt-get update && sudo apt-get install ruby crystal zstd -y

      - name: Run tests
        run: |
          crystal --version
          crystal build --release --static hunaftool.rb
          ./hunaftool
          ruby tests/run-hunaftool-tests.rb ./hunaftool tests
          ruby tests/run-hunaftool-tests.rb "ruby hunaftool.rb" tests
          crystal build --release --static txt2rul.cr
          crystal build --release --static rul2aff.rb
          TMPDIR=. ./txt2rul words.txt | head -n 2000000 > words_suf.rul
          ./rul2aff words_suf.rul > words_suf.aff

      - name: Run tests with the old Crystal 1.6.0 from Debian "bookworm"
        run: |
          wget --quiet https://github.com/crystal-lang/crystal/releases/download/1.6.0/crystal-1.6.0-1-linux-x86_64-bundled.tar.gz
          tar -xzf crystal-1.6.0-1-linux-x86_64-bundled.tar.gz
          crystal-1.6.0-1/bin/crystal --version
          pwd
          export CRYSTAL_LIBRARY_PATH=`pwd`/crystal-1.6.0-1/lib/crystal/lib
          export LD_LIBRARY_PATH=$CRYSTAL_LIBRARY_PATH:$LD_LIBRARY_PATH
          crystal-1.6.0-1/bin/crystal build --release hunaftool.rb -o hunaftool-oldcr
          ruby tests/run-hunaftool-tests.rb ./hunaftool-oldcr tests

      - uses: actions/upload-artifact@v4
        with:
          name: hunaftool-linux-x86_64
          path: |
            hunaftool
            words_suf.rul
            words_suf.aff
